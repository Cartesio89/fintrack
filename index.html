<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1f2937">
  <title>FinTrack Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { overscroll-behavior-y: none; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">
  <div id="app"></div>

  <script>
    const DB_NAME = 'FinTrackDB';
    const DB_VERSION = 1;

    let state = {
      view: 'dashboard',
      accounts: [],
      categories: [],
      transactions: [],
      filterYear: new Date().getFullYear(),
      filterAccount: 'all',
      filterCategory: 'all',
      menuOpen: false,
      currentModal: null,
      editingItem: null
    };

    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('accounts')) {
            db.createObjectStore('accounts', { keyPath: 'id', autoIncrement: true });
          }
          if (!db.objectStoreNames.contains('categories')) {
            db.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
          }
          if (!db.objectStoreNames.contains('transactions')) {
            db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
          }
        };
      });
    }

    async function dbOperation(storeName, mode, operation) {
      const db = await initDB();
      const tx = db.transaction(storeName, mode);
      const store = tx.objectStore(storeName);
      return new Promise((resolve, reject) => {
        const request = operation(store);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    async function loadData() {
      const accs = await dbOperation('accounts', 'readonly', store => store.getAll());
      const cats = await dbOperation('categories', 'readonly', store => store.getAll());
      const txs = await dbOperation('transactions', 'readonly', store => store.getAll());
      state.accounts = accs || [];
      state.categories = cats || [];
      state.transactions = txs || [];
      render();
    }

    async function saveAccount(name, balance) {
      await dbOperation('accounts', 'readwrite', store => store.add({
        name,
        initialBalance: parseFloat(balance),
        createdAt: new Date().toISOString()
      }));
      closeModal();
      await loadData();
    }

    async function saveCategory(name, color) {
      await dbOperation('categories', 'readwrite', store => store.add({
        name,
        color,
        createdAt: new Date().toISOString()
      }));
      closeModal();
      await loadData();
    }

    async function saveTransaction(data) {
      if (state.editingItem) {
        await dbOperation('transactions', 'readwrite', store => store.put({...data, id: state.editingItem.id}));
      } else {
        await dbOperation('transactions', 'readwrite', store => store.add(data));
      }
      closeModal();
      state.editingItem = null;
      await loadData();
    }

    async function deleteItem(storeName, id) {
      if (!confirm('Eliminare questo elemento?')) return;
      await dbOperation(storeName, 'readwrite', store => store.delete(id));
      await loadData();
    }

    async function toggleHidden(tx) {
      await dbOperation('transactions', 'readwrite', store => store.put({...tx, hidden: !tx.hidden}));
      await loadData();
    }

    function getFiltered() {
      return state.transactions.filter(tx => {
        const txDate = new Date(tx.date);
        if (txDate.getFullYear() !== state.filterYear) return false;
        if (tx.hidden && state.view !== 'hidden') return false;
        if (state.filterAccount !== 'all' && tx.accountId !== parseInt(state.filterAccount)) return false;
        if (state.filterCategory !== 'all' && tx.categoryId !== parseInt(state.filterCategory)) return false;
        return true;
      });
    }

    function getMonthlyData() {
      const filtered = getFiltered();
      const monthly = Array(12).fill(0);
      filtered.forEach(tx => {
        const month = new Date(tx.date).getMonth();
        monthly[month] += tx.type === 'income' ? parseFloat(tx.amount) : -parseFloat(tx.amount);
      });
      return monthly;
    }

    function getSummary() {
      const filtered = getFiltered();
      let income = 0, expense = 0;
      filtered.forEach(tx => {
        const amt = parseFloat(tx.amount);
        if (tx.type === 'income') income += amt;
        else expense += amt;
      });
      return { income, expense, balance: income - expense };
    }

    function openModal(type, item = null) {
      state.currentModal = type;
      state.editingItem = item;
      render();
    }

    function closeModal() {
      state.currentModal = null;
      state.editingItem = null;
      render();
    }

    function setView(view) {
      state.view = view;
      state.menuOpen = false;
      render();
    }

    function render() {
      const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
      const monthlyData = getMonthlyData();
      const maxAbs = Math.max(...monthlyData.map(Math.abs), 100);
      const summary = getSummary();
      const filtered = getFiltered().sort((a,b) => new Date(b.date) - new Date(a.date));

      let html = `
        <header class="bg-gray-800 p-4 flex items-center justify-between sticky top-0 z-40 border-b border-gray-700">
          <button onclick="state.menuOpen = !state.menuOpen; render();" class="p-2 hover:bg-gray-700 rounded">‚ò∞</button>
          <h1 class="text-xl font-bold text-blue-400">FinTrack Pro</h1>
          <div class="w-10"></div>
        </header>

        ${state.menuOpen ? `
          <div class="fixed inset-0 bg-gray-800 z-30 p-4 pt-20">
            <button onclick="setView('dashboard')" class="w-full text-left p-3 hover:bg-gray-700 rounded mb-2">üìä Dashboard</button>
            <button onclick="setView('hidden')" class="w-full text-left p-3 hover:bg-gray-700 rounded mb-2">üëÅÔ∏è Nascoste</button>
            <button onclick="setView('accounts')" class="w-full text-left p-3 hover:bg-gray-700 rounded mb-2">üí≥ Conti</button>
            <button onclick="setView('categories')" class="w-full text-left p-3 hover:bg-gray-700 rounded">üè∑Ô∏è Categorie</button>
          </div>
        ` : ''}

        <div class="p-4 pb-20">
      `;

      if (state.view === 'dashboard') {
        html += `
          <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <select onchange="state.filterAccount = this.value; render();" class="w-full bg-gray-700 rounded p-2 mb-2">
              <option value="all">Tutti i conti</option>
              ${state.accounts.map(acc => `<option value="${acc.id}" ${state.filterAccount == acc.id ? 'selected' : ''}>${acc.name}</option>`).join('')}
            </select>
            <select onchange="state.filterCategory = this.value; render();" class="w-full bg-gray-700 rounded p-2 mb-2">
              <option value="all">Tutte categorie</option>
              ${state.categories.map(cat => `<option value="${cat.id}" ${state.filterCategory == cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
            </select>
            <input type="number" value="${state.filterYear}" onchange="state.filterYear = parseInt(this.value); render();" class="w-full bg-gray-700 rounded p-2" />
          </div>

          <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-gray-800 rounded p-3">
              <div class="text-xs text-gray-400">Entrate</div>
              <div class="text-lg font-bold text-green-400">+${summary.income.toFixed(2)}‚Ç¨</div>
            </div>
            <div class="bg-gray-800 rounded p-3">
              <div class="text-xs text-gray-400">Uscite</div>
              <div class="text-lg font-bold text-red-400">-${summary.expense.toFixed(2)}‚Ç¨</div>
            </div>
            <div class="bg-gray-800 rounded p-3">
              <div class="text-xs text-gray-400">Saldo</div>
              <div class="text-lg font-bold ${summary.balance >= 0 ? 'text-green-400' : 'text-red-400'}">
                ${summary.balance >= 0 ? '+' : ''}${summary.balance.toFixed(2)}‚Ç¨
              </div>
            </div>
          </div>

          <div class="bg-gray-800 rounded-lg p-4 mb-4">
            <h2 class="font-bold mb-4">Andamento ${state.filterYear}</h2>
            <div class="flex items-end gap-1 h-56">
              ${monthlyData.map((val, idx) => {
                const h = maxAbs > 0 ? (Math.abs(val) / maxAbs) * 100 : 0;
                const pos = val >= 0;
                return `
                  <div class="flex-1 flex flex-col items-center h-full">
                    <div class="flex-1 flex items-end w-full">
                      ${pos && val !== 0 ? `<div style="height:${h}%" class="w-full bg-green-500 rounded-t"></div>` : ''}
                    </div>
                    <div class="h-0.5 w-full bg-gray-600"></div>
                    <div class="flex-1 flex items-start w-full">
                      ${!pos && val !== 0 ? `<div style="height:${h}%" class="w-full bg-red-500 rounded-b"></div>` : ''}
                    </div>
                    <div class="text-xs mt-1 font-bold ${val === 0 ? 'text-gray-400' : pos ? 'text-green-400' : 'text-red-400'}">
                      ${val !== 0 ? (pos ? '+' : '') + val.toFixed(0) : '0'}‚Ç¨
                    </div>
                    <div class="text-xs text-gray-400">${months[idx]}</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <button onclick="openModal('transaction')" class="w-full bg-blue-600 rounded p-4 font-bold mb-4">‚ûï Aggiungi Transazione</button>

          <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="font-bold mb-3">Transazioni</h2>
            ${filtered.map(tx => {
              const acc = state.accounts.find(a => a.id === tx.accountId);
              const cat = state.categories.find(c => c.id === tx.categoryId);
              return `
                <div class="p-3 rounded bg-gray-700 mb-2">
                  <div class="flex justify-between mb-2">
                    <div>
                      <div class="text-sm text-gray-400">${tx.date}</div>
                      <div class="font-medium">${tx.description || 'Senza descrizione'}</div>
                      <div class="text-sm text-gray-400">${acc?.name || ''} ‚Ä¢ ${cat?.name || ''}</div>
                    </div>
                    <div class="font-bold ${tx.type === 'income' ? 'text-green-400' : 'text-red-400'}">
                      ${tx.type === 'income' ? '+' : '-'}${tx.amount}‚Ç¨
                    </div>
                  </div>
                  <div class="flex gap-1 text-xs">
                    <button onclick='openModal("transaction", ${JSON.stringify(tx).replace(/'/g, "&#39;")})' class="flex-1 p-1.5 bg-gray-600 rounded">‚úèÔ∏è</button>
                    <button onclick='toggleHidden(${JSON.stringify(tx).replace(/'/g, "&#39;")})' class="flex-1 p-1.5 bg-gray-600 rounded">üëÅÔ∏è</button>
                    <button onclick="deleteItem('transactions', ${tx.id})" class="flex-1 p-1.5 bg-red-600 rounded">üóëÔ∏è</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      if (state.view === 'accounts') {
        html += `
          <button onclick="openModal('account')" class="w-full bg-blue-600 rounded p-4 font-bold mb-4">‚ûï Nuovo Conto</button>
          ${state.accounts.map(acc => `
            <div class="bg-gray-800 rounded p-4 flex justify-between items-center mb-2">
              <div>
                <div class="font-bold">${acc.name}</div>
                <div class="text-sm text-gray-400">Saldo iniziale: ${acc.initialBalance}‚Ç¨</div>
              </div>
              <button onclick="deleteItem('accounts', ${acc.id})" class="p-2 bg-red-600 rounded">üóëÔ∏è</button>
            </div>
          `).join('')}
        `;
      }

      if (state.view === 'categories') {
        html += `
          <button onclick="openModal('category')" class="w-full bg-blue-600 rounded p-4 font-bold mb-4">‚ûï Nuova Categoria</button>
          ${state.categories.map(cat => `
            <div class="bg-gray-800 rounded p-4 flex justify-between items-center mb-2">
              <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded" style="background-color:${cat.color}"></div>
                <span class="font-bold">${cat.name}</span>
              </div>
              <button onclick="deleteItem('categories', ${cat.id})" class="p-2 bg-red-600 rounded">üóëÔ∏è</button>
            </div>
          `).join('')}
        `;
      }

      if (state.view === 'hidden') {
        const hidden = state.transactions.filter(tx => tx.hidden && new Date(tx.date).getFullYear() === state.filterYear).sort((a,b) => new Date(b.date) - new Date(a.date));
        html += `
          <div class="bg-gray-800 rounded-lg p-4">
            <h2 class="font-bold mb-3">Transazioni Nascoste</h2>
            ${hidden.map(tx => {
              const acc = state.accounts.find(a => a.id === tx.accountId);
              const cat = state.categories.find(c => c.id === tx.categoryId);
              return `
                <div class="p-3 rounded bg-gray-700/50 mb-2">
                  <div class="flex justify-between mb-2">
                    <div>
                      <div class="text-sm text-gray-400">${tx.date}</div>
                      <div class="font-medium">${tx.description || 'Senza descrizione'}</div>
                      <div class="text-sm text-gray-400">${acc?.name || ''} ‚Ä¢ ${cat?.name || ''}</div>
                    </div>
                    <div class="font-bold ${tx.type === 'income' ? 'text-green-400' : 'text-red-400'}">
                      ${tx.type === 'income' ? '+' : '-'}${tx.amount}‚Ç¨
                    </div>
                  </div>
                  <div class="flex gap-1 text-xs">
                    <button onclick='toggleHidden(${JSON.stringify(tx).replace(/'/g, "&#39;")})' class="flex-1 p-1.5 bg-gray-600 rounded">üëÅÔ∏è Mostra</button>
                    <button onclick="deleteItem('transactions', ${tx.id})" class="flex-1 p-1.5 bg-red-600 rounded">üóëÔ∏è</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      html += '</div>';

      // Modals
      if (state.currentModal === 'account') {
        html += `
          <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
              <h2 class="text-xl font-bold mb-4">Nuovo Conto</h2>
              <input id="acc-name" placeholder="Nome" class="w-full bg-gray-700 rounded p-2 mb-2" />
              <input id="acc-balance" type="number" value="0" placeholder="Saldo iniziale" class="w-full bg-gray-700 rounded p-2 mb-4" />
              <div class="flex gap-2">
                <button onclick="saveAccount(document.getElementById('acc-name').value, document.getElementById('acc-balance').value)" class="flex-1 bg-blue-600 rounded p-2 font-bold">Salva</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-700 rounded p-2">Annulla</button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'category') {
        html += `
          <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
              <h2 class="text-xl font-bold mb-4">Nuova Categoria</h2>
              <input id="cat-name" placeholder="Nome" class="w-full bg-gray-700 rounded p-2 mb-2" />
              <input id="cat-color" type="color" value="#3b82f6" class="w-full bg-gray-700 rounded p-2 h-12 mb-4" />
              <div class="flex gap-2">
                <button onclick="saveCategory(document.getElementById('cat-name').value, document.getElementById('cat-color').value)" class="flex-1 bg-blue-600 rounded p-2 font-bold">Salva</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-700 rounded p-2">Annulla</button>
              </div>
            </div>
          </div>
        `;
      }

      if (state.currentModal === 'transaction') {
        const editing = state.editingItem;
        html += `
          <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 overflow-y-auto">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md my-8">
              <h2 class="text-xl font-bold mb-4">${editing ? 'Modifica' : 'Nuova'} Transazione</h2>
              <input id="tx-desc" value="${editing?.description || ''}" placeholder="Descrizione" class="w-full bg-gray-700 rounded p-2 mb-2 text-sm" />
              <select id="tx-acc" class="w-full bg-gray-700 rounded p-2 mb-2 text-sm">
                <option value="">Seleziona conto</option>
                ${state.accounts.map(a => `<option value="${a.id}" ${editing?.accountId === a.id ? 'selected' : ''}>${a.name}</option>`).join('')}
              </select>
              <select id="tx-cat" class="w-full bg-gray-700 rounded p-2 mb-2 text-sm">
                <option value="">Seleziona categoria</option>
                ${state.categories.map(c => `<option value="${c.id}" ${editing?.categoryId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
              </select>
              <select id="tx-type" class="w-full bg-gray-700 rounded p-2 mb-2 text-sm">
                <option value="income" ${editing?.type === 'income' ? 'selected' : ''}>Entrata</option>
                <option value="expense" ${editing?.type === 'expense' ? 'selected' : ''}>Uscita</option>
              </select>
              <input id="tx-amount" type="number" step="0.01" value="${editing?.amount || 0}" placeholder="Importo" class="w-full bg-gray-700 rounded p-2 mb-2 text-sm" />
              <input id="tx-date" type="date" value="${editing?.date || new Date().toISOString().split('T')[0]}" class="w-full bg-gray-700 rounded p-2 mb-2 text-sm" />
              <label class="flex items-center gap-2 mb-4">
                <input id="tx-hidden" type="checkbox" ${editing?.hidden ? 'checked' : ''} />
                <span class="text-sm">Nascondi dalle analisi</span>
              </label>
              <div class="flex gap-2">
                <button onclick="saveTransaction({description: document.getElementById('tx-desc').value, accountId: parseInt(document.getElementById('tx-acc').value), categoryId: parseInt(document.getElementById('tx-cat').value), type: document.getElementById('tx-type').value, amount: parseFloat(document.getElementById('tx-amount').value), date: document.getElementById('tx-date').value, hidden: document.getElementById('tx-hidden').checked, createdAt: '${editing?.createdAt || new Date().toISOString()}', updatedAt: new Date().toISOString()})" class="flex-1 bg-blue-600 rounded p-2 font-bold">Salva</button>
                <button onclick="closeModal()" class="flex-1 bg-gray-700 rounded p-2">Annulla</button>
              </div>
            </div>
          </div>
        `;
      }

      document.getElementById('app').innerHTML = html;
    }

    // Init
    loadData();
  </script>
</body>
</html>
